<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarSpotter AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00bfff;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #f0f0f0;
            --text-secondary-color: #a0a0a0;
            --border-color: #333;
            --error-color: #ff5555;
            --glow-color: rgba(0, 191, 255, 0.4);
        }
        *, *::before, *::after { box-sizing: border-box; }
        *:focus, *:focus-visible { outline: none !important; box-shadow: none !important; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        #app-container { width: 100%; max-width: 750px; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }
        header { text-align: center; margin-bottom: 30px; }
        header h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-color);
            margin: 0;
            font-size: 2.5em;
            text-shadow: 0 0 15px var(--glow-color);
        }
        #upload-container {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
        }
        #upload-container:hover, #upload-container.dragover { border-color: var(--primary-color); background-color: #2a2a2a; }
        #upload-container.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        #upload-label { cursor: pointer; }
        #upload-label svg { width: 50px; height: 50px; color: var(--primary-color); margin-bottom: 15px; }
        #upload-label p { margin: 0; font-size: 1.1em; color: var(--text-secondary-color); }
        #upload-label p strong { color: var(--primary-color); font-weight: 700; }
        #file-input { display: none; }
        
        #results-area { margin-top: 30px; }
        
        #image-wrapper {
            position: relative;
            max-width: 100%;
            margin: 0 auto 30px auto;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        #image-wrapper img {
            display: block;
            width: 100%;
            height: auto;
        }
        #bounding-box-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
        }
        .bounding-box {
            position: absolute;
            border: 2px solid var(--primary-color);
            background-color: rgba(0, 191, 255, 0.2);
            box-shadow: 0 0 10px var(--glow-color);
            pointer-events: all; 
            transition: background-color 0.2s ease;
            border-radius: 4px;
        }

        /* --- FIX 3: IMPROVED LABEL PLACEMENT --- */
        /* This places the label *inside* the top-left of the box,
           making it more reliable and preventing it from appearing off-screen. */
        .bounding-box .box-label {
            position: absolute;
            top: 0;
            left: 0;
            background-color: var(--primary-color);
            color: var(--background-color);
            padding: 2px 6px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
            border-radius: 0 0 4px 0; /* Rounded corner for the bottom-right of the label */
        }
        .bounding-box.highlighted, .bounding-box:hover {
            background-color: rgba(0, 191, 255, 0.4);
        }
        
        #results-container { display: grid; gap: 20px; }

        details.car-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        details.car-card.highlighted {
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--glow-color);
        }
        details.car-card summary { cursor: pointer; list-style: none; }
        details.car-card summary::-webkit-details-marker { display: none; }
        details.car-card summary h3 { display: inline-block; font-family: 'Orbitron', sans-serif; font-size: 1.6em; color: var(--primary-color); margin: 0 0 15px 0;}
        details.car-card ul { list-style: none; padding-left: 0; margin-top: 15px; }
        details.car-card li { line-height: 1.7; margin-bottom: 5px; }
        
        #loader { text-align: center; padding: 20px 0; margin: 0; }
        .loader-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        .loader-text { font-size: 1em; color: var(--text-secondary-color); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .hidden { display: none; }
        @keyframes flash { 0% { box-shadow: 0 0 15px var(--glow-color); } 100% { box-shadow: none; } }
        .pasting { animation: flash 0.5s ease-out; }

        footer {
            width: 100%;
            max-width: 750px;
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary-color);
        }
        footer p { line-height: 1.6; margin-bottom: 1em; }
        .footer-links { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; }
        .email-container { display: flex; align-items: center; gap: 10px; background: var(--surface-color); padding: 8px 15px; border-radius: 10px; border: 1px solid var(--border-color); }
        #email-text { font-family: monospace; font-size: 1.1em; }
        #copy-email-btn { background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; color: var(--text-secondary-color); }
        #copy-email-btn:hover { color: var(--primary-color); }
        .footer-links svg { width: 36px; height: 36px; }
        #copy-email-btn svg { width: 24px; height: 24px; }
        .footer-links a { color: var(--text-secondary-color); transition: color 0.2s; }
        .footer-links a:hover { color: var(--primary-color); }
        
        @media (max-width: 768px) {
            body { padding: 20px 15px; }
            header h1 { font-size: 2em; }
            .car-card h3 { font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header><h1>CarSpotter AI</h1></header>
        <main>
            <div id="upload-container">
                <input type="file" id="file-input" accept="image/*">
                <label for="file-input" id="upload-label">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <p><strong>Click to upload</strong>, drag & drop, or paste an image</p>
                </label>
            </div>
            
            <div id="loader" class="hidden">
                <div class="loader-spinner"></div>
                <p class="loader-text">AI is spotting... Wait for a few seconds ;)</p>
            </div>

            <div id="results-area" class="hidden">
                <div id="image-wrapper">
                    <img id="image-preview" src="" alt="Uploaded Car Image Preview">
                    <div id="bounding-box-overlay"></div>
                </div>
                <div id="results-container"></div>
            </div>
        </main>
    </div>

    <footer>
        <p>আমি একজন web/software developer (or at least thats what i think of myself lol). আমি কোন প্রজেক্ট আইডিয়া পাচ্ছিলাম না তাই এই ছোটখাটো প্রজেক্ট টা বানালাম । এখানে যদি কোন সমস্যা অথবা ERROR চোখে পড়ে তাহলে আমার সাথে যোগাযোগ করতে পারেন।</p>
        <p>Most importantly আমি প্রজেক্ট আইডিয়া খুঁজছি। তাই যদি আপনি আমাকে কোন প্রজেক্ট আইডিয়া দিতে পারেন যেটা আপনার জন্যও helpful হবে। আর আমিও একটা real world problem solve করতে পারব। চাইলেই ফেসবুকে মেসেজ দিতে পারেন অথবা ইমেইল পাঠাতে পারেন নিচে দেওয়া gmail account এ। নিচের facebook icon এ ক্লিক করলে আমার ফেসবুক আইকাউট ওপেন হবে। ধন্যবাদ :)</p>
        <div class="footer-links">
            <div class="email-container">
                <span id="email-text">snokejj312@gmail.com</span>
                <button id="copy-email-btn" title="Copy email">
                    <svg id="copy-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    <svg id="check-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </button>
            </div>
            <a href="https://www.facebook.com/profile.php?id=100083669199391" target="_blank" rel="noopener noreferrer" title="Message me on Facebook">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z"></path></svg>
            </a>
        </div>
    </footer>

    <script>
        const uploadContainer = document.getElementById('upload-container');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const resultsArea = document.getElementById('results-area');
        const imagePreview = document.getElementById('image-preview');
        const resultsContainer = document.getElementById('results-container');
        const boxOverlay = document.getElementById('bounding-box-overlay');
        const copyEmailBtn = document.getElementById('copy-email-btn');
        const copyIcon = document.getElementById('copy-icon');
        const checkIcon = document.getElementById('check-icon');

        let isProcessing = false;

        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
        window.addEventListener('paste', handlePaste);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
            document.body.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); });
            if (eName === 'dragenter' || eName === 'dragover') {
                uploadContainer.addEventListener(eName, () => { if (!isProcessing) uploadContainer.classList.add('dragover'); });
            } else {
                uploadContainer.addEventListener(eName, () => uploadContainer.classList.remove('dragover'));
            }
        });
        uploadContainer.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        
        copyEmailBtn.addEventListener('click', () => {
            navigator.clipboard.writeText('snokejj312@gmail.com').then(() => {
                copyIcon.classList.add('hidden');
                checkIcon.classList.remove('hidden');
                setTimeout(() => {
                    copyIcon.classList.remove('hidden');
                    checkIcon.classList.add('hidden');
                }, 2000);
            }).catch(err => console.error('Failed to copy email:', err));
        });

        function handlePaste(event) {
            if (isProcessing) return;
            const file = event.clipboardData?.files[0];
            if (file && file.type.includes('image')) {
                uploadContainer.classList.add('pasting');
                setTimeout(() => uploadContainer.classList.remove('pasting'), 500);
                handleFile(file);
            }
        }

        function clearResults() {
            resultsArea.classList.add('hidden');
            resultsContainer.innerHTML = '';
            boxOverlay.innerHTML = '';
            imagePreview.src = '';
        }
        
        function addInteractivity() {
            const boxes = document.querySelectorAll('.bounding-box');
            const cards = document.querySelectorAll('.car-card');

            boxes.forEach(box => {
                const card = document.getElementById(box.dataset.cardId);
                box.addEventListener('mouseenter', () => {
                    card.classList.add('highlighted');
                    box.classList.add('highlighted');
                });
                box.addEventListener('mouseleave', () => {
                    card.classList.remove('highlighted');
                    box.classList.remove('highlighted');
                });
            });

            cards.forEach(card => {
                const box = document.getElementById(card.dataset.boxId);
                card.addEventListener('mouseenter', () => {
                    box.classList.add('highlighted');
                    card.classList.add('highlighted');
                });
                card.addEventListener('mouseleave', () => {
                    box.classList.remove('highlighted');
                    card.classList.remove('highlighted');
                });
            });
        }


        async function handleFile(file) {
            if (!file || isProcessing) return;
            isProcessing = true;
            uploadContainer.classList.add('disabled');
            clearResults();
            loader.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('image', file);
            
            imagePreview.src = URL.createObjectURL(file);
            
            imagePreview.onload = async () => {
                try {
                    const response = await fetch('/identify-car', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error((await response.json()).detail || 'Server error');
                    const data = await response.json();
                    
                    const carBlocks = data.identification.split('### ').filter(b => b.trim() !== '' && !b.startsWith('<example>'));
                    let cardsHTML = '';
                    let boxesHTML = '';

                    carBlocks.forEach((block, index) => {
                        const carId = `car-${index}`;
                        const boxId = `box-${index}`;
                        
                        const lines = block.split('\n').filter(l => l.trim() !== '' && !l.includes('</example>'));
                        const title = lines[0]?.trim()?.replace(/\*\*/g, '') || 'Unnamed Car';
                        const isUnspecified = title.toLowerCase().includes('unspecified');

                        let boundingBox = null;
                        const boxLine = lines.find(line => line.includes('- **BoundingBox:**'));
                        if (boxLine) {
                            try {
                                const coordsStr = boxLine.substring(boxLine.indexOf('[') + 1, boxLine.indexOf(']'));
                                boundingBox = JSON.parse(`[${coordsStr}]`);
                            } catch (e) {
                                console.error("Could not parse bounding box:", boxLine);
                            }
                        }

                        if (boundingBox && boundingBox.length === 4) {
                            const [x_min, y_min, x_max, y_max] = boundingBox;
                            const boxLeft = x_min * 100;
                            const boxTop = y_min * 100;
                            const boxWidth = (x_max - x_min) * 100;
                            const boxHeight = (y_max - y_min) * 100;
                            
                            boxesHTML += `
                                <div class="bounding-box" id="${boxId}" data-card-id="${carId}" style="left: ${boxLeft}%; top: ${boxTop}%; width: ${boxWidth}%; height: ${boxHeight}%;">
                                    <div class="box-label">${title}</div>
                                </div>
                            `;
                        }
                        
                        const detailsList = lines.slice(1)
                                                 .filter(line => !line.includes('BoundingBox:'))
                                                 .map(line => line.trim())
                                                 .join('\n');
                        
                        cardsHTML += `
                            <details class="car-card" id="${carId}" data-box-id="${boxId}" ${!isUnspecified ? 'open' : ''}>
                                <summary><h3>${title}</h3></summary>
                                <ul>
                                    ${detailsList.replace(/- \*\*(.*?):\*\* (.*)/g, '<li><strong>$1:</strong> $2</li>')}
                                </ul>
                            </details>
                        `;
                    });

                    resultsContainer.innerHTML = cardsHTML;
                    boxOverlay.innerHTML = boxesHTML;
                    addInteractivity(); 

                } catch (error) {
                    resultsContainer.innerHTML = `<div class="car-card"><h3 style="color: var(--error-color);">Identification Failed</h3><p>${error.message}</p></div>`;
                    console.error('CarSpotter AI Error:', error);
                } finally {
                    loader.classList.add('hidden');
                    resultsArea.classList.remove('hidden');
                    isProcessing = false;
                    uploadContainer.classList.remove('disabled');
                }
            };
            
            imagePreview.onerror = () => {
                 resultsContainer.innerHTML = `<div class="car-card"><h3 style="color: var(--error-color);">Error</h3><p>Could not load the image file.</p></div>`;
                 loader.classList.add('hidden');
                 resultsArea.classList.remove('hidden');
                 isProcessing = false;
                 uploadContainer.classList.remove('disabled');
            };
        }
    </script>
</body>
</html>